#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# TSHLA Medical - Pre-Commit Hook
# Prevents committing broken code

echo "üîç Running pre-commit validation..."
echo ""

# Check staticwebapp.config.json location
if [ ! -f "public/staticwebapp.config.json" ]; then
  echo "‚ùå staticwebapp.config.json must be in public/ folder, not root!"
  echo "   This will cause 404 errors on /admin/* routes in production."
  echo ""
  echo "   Fix: mv staticwebapp.config.json public/"
  echo ""
  exit 1
fi
echo "‚úÖ staticwebapp.config.json in correct location (public/)"

# Check for accidentally committed credentials (exclude dev scripts, docs, and comparison checks)
if git diff --cached -- ':!start-dev.sh' ':!stop-dev.sh' ':!*.md' | grep -i "DB_PASSWORD.*=.*[^'']" | grep -v "DB_PASSWORD=\$" | grep -v 'DB_PASSWORD=""' | grep -v '===' | grep -v '!=='; then
  echo "‚ùå Found hardcoded credentials in staged files!"
  echo "   Never commit passwords directly in code."
  echo ""
  exit 1
fi
echo "‚úÖ No hardcoded credentials detected"

# Check for deprecated auth service imports
echo ""
echo "Checking for deprecated auth service imports..."
DEPRECATED_IMPORTS=$(git diff --cached --name-only | grep -E '\.(ts|tsx)$' | grep -v "pumpAuth\.service\.ts$" | xargs grep -l "from.*pumpAuth\.service" 2>/dev/null || true)
if [ -n "$DEPRECATED_IMPORTS" ]; then
  echo "‚ùå Found imports of deprecated pumpAuth.service!"
  echo ""
  echo "   Files with deprecated imports:"
  echo "$DEPRECATED_IMPORTS" | sed 's/^/     - /'
  echo ""
  echo "   ‚ö†Ô∏è  pumpAuth.service is deprecated and will be removed."
  echo "   ‚úÖ Use supabaseAuth.service instead."
  echo ""
  echo "   Migration example:"
  echo "     // ‚ùå Old (deprecated):"
  echo "     import { pumpAuthService } from './pumpAuth.service';"
  echo ""
  echo "     // ‚úÖ New (correct):"
  echo "     import { supabaseAuthService } from './supabaseAuth.service';"
  echo ""
  exit 1
fi
echo "‚úÖ No deprecated auth imports detected"

# Check for console.log in server code (HIPAA compliance)
echo ""
echo "Checking for console.log statements in server code (HIPAA)..."
# Exclude comment lines (starting with * or //) and deprecated services
CONSOLE_FOUND=$(git diff --cached --name-only | grep -E '^server/.*\.(js|ts)$' | grep -v '_deprecated_external_services/' | xargs grep "console\." 2>/dev/null | grep -v "^\s*\*" | grep -v "^\s*//" | cut -d: -f1 | sort -u || true)
if [ -n "$CONSOLE_FOUND" ]; then
  echo "‚ùå console.log statements found in server code!"
  echo ""
  echo "   Files with console statements:"
  echo "$CONSOLE_FOUND" | sed 's/^/     - /'
  echo ""
  echo "   ‚ö†Ô∏è  HIPAA Compliance: console.log exposes PHI in production logs"
  echo "   ‚úÖ Use logger instead:"
  echo ""
  echo "   Migration examples:"
  echo "     // ‚ùå Old (HIPAA violation):"
  echo "     console.log('Processing patient:', patientName);"
  echo ""
  echo "     // ‚úÖ New (HIPAA compliant):"
  echo "     logger.info('Category', 'Processing patient', { patientId });"
  echo ""
  echo "   See: HIPAA-SAFE-LOGGING-GUIDE.md"
  echo ""
  exit 1
fi
echo "‚úÖ No console.log statements in server code"

# Check TypeScript compiles
echo ""
echo "Running TypeScript check..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå TypeScript errors found. Fix them before committing."
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
echo "   Proceeding with commit..."
echo ""
