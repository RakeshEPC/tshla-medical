import{u as B,r,b as u,j as e}from"./index-JAW6HvUl.js";import{patientService as K}from"./patient.service-CxaGvQcl.js";import{a as A}from"./awsTranscribeMedicalStreamingFixed.service-BNg944jX.js";function U(){const b=B(),[a,k]=r.useState(null),[p,d]=r.useState([]),[m,v]=r.useState(""),[g,w]=r.useState("text"),[$,f]=r.useState(!1),[o,j]=r.useState(!1),[P,N]=r.useState(!1),[h,y]=r.useState(""),I=r.useRef(null),R=r.useRef(null);r.useEffect(()=>{D(),M()},[]),r.useEffect(()=>{T()},[p]);const T=()=>{I.current?.scrollIntoView({behavior:"smooth"})},D=()=>{const t=K.getCurrentPatient();if(!t){b("/patient-login");return}k(t)},M=()=>{const t=localStorage.getItem("patient_chat_history");if(t)try{const s=JSON.parse(t);d(s)}catch{u("PatientChat","Error message",{})}else{const s={id:`msg_${Date.now()}`,patientId:"",timestamp:new Date().toISOString(),sender:"ai",type:"text",content:"Hello! I'm AVA, your personal health assistant. I'm here to help you with your health journey. What would you like to discuss today?",metadata:{sentiment:"positive",topic:"greeting"}};d([s])}},E=t=>{localStorage.setItem("patient_chat_history",JSON.stringify(t))},_=async()=>{f(!0),y("");try{await A.startRecording({onTranscript:t=>{y(t)},onError:t=>{u("PatientChat","Error message",{}),S()},mode:"dictation"})}catch{u("PatientChat","Error message",{}),f(!1)}},S=async()=>{f(!1),A.stopRecording(),h.length>0&&(await l(h,"voice"),y(""))},l=async(t,s="text")=>{if(!t.trim()||!a)return;const n={id:`msg_${Date.now()}`,patientId:a.internalId,timestamp:new Date().toISOString(),sender:"patient",type:s,content:t},i=[...p,n];d(i),v(""),j(!0);try{const c=await V(t),x=await azureAIService.processWithClaude(c,"patient_chat"),z={id:`msg_${Date.now()}_ai`,patientId:a.internalId,timestamp:new Date().toISOString(),sender:"ai",type:"text",content:x,metadata:{sentiment:L(x),topic:O(t)}},C=[...i,z];d(C),E(C),await H(x)}catch{u("PatientChat","Error message",{});const x={id:`msg_${Date.now()}_error`,patientId:a.internalId,timestamp:new Date().toISOString(),sender:"ai",type:"text",content:"I apologize, but I'm having trouble processing your message. Please try again.",metadata:{sentiment:"neutral"}};d([...i,x])}finally{j(!1)}},V=async t=>{if(!a)return t;let s=`You are AVA, a compassionate and knowledgeable AI health assistant for TSHLA Medical. 
You are chatting with ${a.firstName} ${a.lastName}.

Patient Information:
- AVA ID: ${a.patientAvaId}
- Programs Enrolled: ${Object.entries(a.programs).filter(([n,i])=>i?.enrolled).map(([n])=>n).join(", ")}
`;if(a.programs.pumpdrive?.finalRecommendations){const n=a.programs.pumpdrive.finalRecommendations[0];s+=`
- Recommended Pump: ${n.pumpName} (${n.matchScore}% match)
- Key Reasons: ${n.keyReasons.join(", ")}
`}return a.programs.weightloss?.enrolled&&(s+=`
- Weight Loss Program: ${a.programs.weightloss.currentPhase||"Active"}
- Last Check-in: ${a.programs.weightloss.lastCheckin||"Not yet"}
`),s+=`

Recent Conversation:
${p.slice(-5).map(n=>`${n.sender==="patient"?"Patient":"AVA"}: ${n.content}`).join(`
`)}

Patient's Current Message: ${t}

Guidelines for your response:
1. Be supportive, encouraging, and positive
2. If discussing pumps, emphasize why their recommended pump is perfect for them
3. Provide specific, actionable advice
4. Use the patient's name occasionally for personalization
5. Keep responses concise but helpful
6. If they have concerns, address them with empathy
7. Celebrate their progress and commitment to health
8. For weight loss questions, provide evidence-based guidance
9. Always maintain HIPAA compliance

Respond naturally and conversationally:`,s},H=async t=>{N(!0);try{await elevenLabsService.speak(t,"21m00Tcm4TlvDq8ikWAM")}catch{u("PatientChat","Error message",{})}finally{N(!1)}},L=t=>{const s=["great","excellent","wonderful","perfect","amazing","congratulations"],n=["concern","worry","difficult","challenge","problem"],i=t.toLowerCase();return s.some(c=>i.includes(c))?"positive":n.some(c=>i.includes(c))?"concerned":"neutral"},O=t=>{const s=t.toLowerCase();return s.includes("pump")||s.includes("insulin")?"pumpdrive":s.includes("weight")||s.includes("diet")||s.includes("exercise")?"weightloss":s.includes("check")||s.includes("progress")?"progress":"general"},W=t=>new Date(t).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return a?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex flex-col",children:[e.jsx("header",{className:"bg-white shadow-sm border-b",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>b("/patient/dashboard"),className:"text-gray-600 hover:text-gray-900",children:"â† Back"}),e.jsx("div",{className:"h-8 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-600 to-green-600 rounded-full flex items-center justify-center text-white text-xs font-bold",children:"AVA"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:"AVA Health Assistant"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Always here to help"})]})]})]}),P&&e.jsxs("div",{className:"flex items-center space-x-2 bg-blue-100 px-3 py-1 rounded-full",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-1.5 h-3 bg-blue-500 rounded-full animate-pulse"}),e.jsx("div",{className:"w-1.5 h-4 bg-blue-600 rounded-full animate-pulse",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-1.5 h-3 bg-blue-500 rounded-full animate-pulse",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-xs text-blue-700",children:"Speaking..."})]})]})})}),e.jsx("div",{ref:R,className:"flex-1 max-w-4xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 overflow-y-auto",children:e.jsxs("div",{className:"space-y-4",children:[p.map(t=>e.jsx("div",{className:`flex ${t.sender==="patient"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-2xl ${t.sender==="patient"?"order-2":"order-1"}`,children:e.jsxs("div",{className:"flex items-end space-x-2",children:[t.sender==="ai"&&e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-600 to-green-600 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0",children:"AVA"}),e.jsxs("div",{children:[e.jsxs("div",{className:`rounded-2xl px-4 py-3 ${t.sender==="patient"?"bg-blue-600 text-white":"bg-white shadow-md"}`,children:[e.jsx("p",{className:t.sender==="patient"?"text-white":"text-gray-800",children:t.content}),t.type==="voice"&&e.jsxs("div",{className:`text-xs mt-1 flex items-center space-x-1 ${t.sender==="patient"?"text-blue-100":"text-gray-400"}`,children:[e.jsx("span",{children:"ðŸŽ¤"}),e.jsx("span",{children:"Voice message"})]})]}),e.jsx("div",{className:`text-xs mt-1 ${t.sender==="patient"?"text-right":"text-left"} text-gray-400`,children:W(t.timestamp)})]}),t.sender==="patient"&&e.jsxs("div",{className:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 text-xs font-bold flex-shrink-0",children:[a.firstName[0],a.lastName[0]]})]})})},t.id)),o&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"flex items-center space-x-2 bg-white shadow-md rounded-2xl px-4 py-3",children:e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]})})}),e.jsx("div",{ref:I})]})}),e.jsx("div",{className:"bg-white border-t",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4",children:[e.jsx("div",{className:"flex justify-center mb-3",children:e.jsxs("div",{className:"inline-flex bg-gray-100 rounded-lg p-0.5",children:[e.jsx("button",{onClick:()=>w("text"),className:`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${g==="text"?"bg-white shadow-sm text-blue-600":"text-gray-600"}`,children:"âŒ¨ï¸ Type"}),e.jsx("button",{onClick:()=>w("voice"),className:`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${g==="voice"?"bg-white shadow-sm text-blue-600":"text-gray-600"}`,children:"ðŸŽ¤ Voice"})]})}),g==="text"?e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("input",{type:"text",value:m,onChange:t=>v(t.target.value),onKeyPress:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),l(m))},placeholder:"Type your message...",disabled:o,className:"flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("button",{onClick:()=>l(m),disabled:!m.trim()||o,className:`px-6 py-3 rounded-xl font-semibold transition-all ${!m.trim()||o?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-green-600 text-white hover:from-blue-700 hover:to-green-700"}`,children:"Send"})]}):e.jsx("div",{className:"text-center",children:$?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:S,className:"w-20 h-20 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white shadow-lg animate-pulse",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2"})})})}),h&&e.jsx("div",{className:"bg-gray-50 rounded-lg p-3 text-sm text-gray-700",children:h}),e.jsx("p",{className:"text-sm text-gray-500",children:"Tap to stop recording"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:_,disabled:o,className:`w-20 h-20 rounded-full flex items-center justify-center shadow-lg transition-all ${o?"bg-gray-300 cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-green-600 text-white hover:from-blue-700 hover:to-green-700"}`,children:e.jsxs("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z"}),e.jsx("path",{d:"M19 10v1a7 7 0 0 1-14 0v-1M12 18.75v3.25M8 21h8"})]})})}),e.jsx("p",{className:"text-sm text-gray-500",children:"Tap to start recording"})]})}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Try asking:"}),a.programs.pumpdrive?.finalRecommendations&&e.jsx("button",{onClick:()=>l("Tell me more about my recommended pump"),className:"text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200",children:"About my pump recommendation"}),a.programs.weightloss?.enrolled&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>l("What should I eat today?"),className:"text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200",children:"Meal suggestions"}),e.jsx("button",{onClick:()=>l("How can I stay motivated?"),className:"text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full hover:bg-purple-200",children:"Motivation tips"})]})]})]})})]}):null}export{U as default};
//# sourceMappingURL=PatientChat-D6T0Qxr7.js.map
