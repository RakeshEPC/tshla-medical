name: HIPAA Console.log Check

on:
  pull_request:
    paths:
      - 'server/**/*.js'
      - 'server/**/*.ts'
  push:
    branches:
      - main
    paths:
      - 'server/**/*.js'
      - 'server/**/*.ts'

jobs:
  check-console-statements:
    runs-on: ubuntu-latest
    name: Check for console.log in server code

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for console statements
        continue-on-error: true
        run: |
          echo "üîç Checking for console.log statements in server code..."

          # Check production server files for console statements
          # Exclude: node_modules, deprecated services, migration/debug scripts, logger itself
          # Production server files only ‚Äî exclude non-production code
          CONSOLE_FILES=$(grep -r "console\." server/ \
            --include="*.js" --include="*.ts" \
            --exclude-dir=node_modules \
            --exclude-dir=_deprecated_external_services \
            -l 2>/dev/null | \
            grep -v 'logger.js' | \
            grep -v 'migrations/' | \
            grep -v 'migrate-' | \
            grep -v 'debug-' | \
            grep -v 'check_call' | \
            grep -v 'check_latest' | \
            grep -v 'check-and-seed' | \
            grep -v 'trigger-' | \
            grep -v 'register-diabetes' | \
            grep -v 'deepgram-proxy' | \
            grep -v 'test-' | \
            grep -v 'seed-pump' | \
            grep -v 'generate-admin' | \
            grep -v 'import-pump' | \
            grep -v 'previsit-api-server' | \
            grep -v 'diagnostic-endpoints' || true)

          if [ -n "$CONSOLE_FILES" ]; then
            echo ""
            echo "‚ùå HIPAA VIOLATION: console.log statements found in server code!"
            echo ""
            echo "Files with console statements:"
            echo "$CONSOLE_FILES" | sed 's/^/  - /'
            echo ""
            echo "HIPAA Compliance Requirement:"
            echo "  Production logs must not contain PHI (Protected Health Information)"
            echo "  console.log() can expose patient names, DOB, phone, medical data"
            echo ""
            echo "Required fix:"
            echo "  Replace all console.log with logger from ./server/logger.js"
            echo ""
            echo "Examples:"
            echo "  ‚ùå console.log('Patient:', patient.name)"
            echo "  ‚úÖ logger.info('Category', 'Processing patient', { patientId })"
            echo ""
            echo "  ‚ùå console.error('Error:', error)"
            echo "  ‚úÖ logger.error('Category', 'Error', { error: error.message })"
            echo ""
            echo "See: HIPAA-SAFE-LOGGING-GUIDE.md"
            echo ""
            exit 1
          fi

          echo "‚úÖ No console.log statements found in production server code - HIPAA compliant"

      - name: Report success
        if: success()
        run: |
          echo ""
          echo "‚úÖ HIPAA Console Check PASSED"
          echo "   All server logging uses safe logger"
          echo ""
